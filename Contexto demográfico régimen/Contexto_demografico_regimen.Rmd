---
title: "Informe Contexto Demográfico del Régimen"
author: "Alejandro Brenes, Santiago Fernández, Eyeri Méndez y Erick Venegas"
date: "`r Sys.Date()`"
output: html_document
---

Se cargan las librerías necesarias.

```{r librerias}
pacman::p_load(dplyr,
               ggplot2,
               readxl,
               lubridate,
               tidyr)
```

Se leen las bases de cotizantes y pensionados.

```{r datos_bases}
cotizantes <- read_excel("data/BD_Cotizantes.xlsx")
pensionados <- read_excel("data/BD_Pensionados.xlsx")

# Se corrigen los nombres de las columnas de la base de cotizantes
colnames(cotizantes)[4:363] <- format(seq(from = ymd("1995-01-01"), to = ymd("2024-12-01"), by = "1 month"), "%m-%Y")
```

## Estructura de la población

```{r estrc_pob}

```

## Población activa

```{r pob_actv}

```


## Población pensionada

En esta sección se presenta un análisis descriptivo de las personas ya pensionadas en la fecha de corte.

```{r pob_pensd}
# Frecuencia de la variable sexo separado por tipo de pensión.
ggplot(pensionados, aes(x = COD_TIPO_PENSION, fill = SEXO)) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = c("M" = "cornflowerblue", 
                               "F" = "lightpink"),
                    labels = c("M" = "Hombre", "F" = "Mujer")) +
  scale_x_discrete(labels = c("VEJEZ" = "Vejez", 
                              "INVALIDEZ" = "Invalidez", 
                              "SUCESION" = "Sucesión")) +
  labs(x = "Tipo de Pensión", 
       y = "Frecuencia", 
       fill = "Sexo") +
  theme_minimal()
```

Seguidamente, se muestra un gráfico con la antigüedad de los pensionados.

```{r antiguedad}
# Se crea la nueva columna con las duraciones en meses de las pensiones.
pensionados <- pensionados %>%
  mutate(duracion = interval(ymd(`Rige de la Pensión`), ymd("2024-12-31")) %/% months(1))

# Se plotea la nueva variable.
ggplot(pensionados, aes(x = duracion)) +
  geom_histogram(binwidth = 8, fill = "steelblue", color = "white") +
  labs(x = "Meses de duración",
       y = "Frecuencia") +
  theme_minimal()
```


## Comportamiento de altas y bajas

Se inicia contabilizando la cantidad de pensionados, esto se separa de los cotizados debido a que solo hay 365 pensionados, mientras que hay más de 5000 cotizantes. Lo cual generaría una diferencia de escala considerable en los gráficos finales.

```{r pensionados}
# DataFrame con Los pensionados por cada mes
num.pensionados <-
  data.frame(meses = ceiling_date(seq(
    from = ymd("1995-01-01"),
    to = ymd("2024-12-01"),
    by = "1 month"
  ), "month") - days(1),
  pensionados = 0)

# Se rellenan los pensionados por mes
for (i in 1:nrow(num.pensionados)) {
  num.pensionados[i, 2] <-
    sum(pensionados$`Rige de la Pensión` <= num.pensionados[i, 1])
}

# Gráfico con los pensionados
ggplot(num.pensionados, aes(x = meses, y = pensionados)) +
  geom_line(color = "blueviolet", linewidth = 0.75) +
  labs(x = "Tiempo", y = "Personas pensionadas") +
  theme_minimal()
```

Luego, se muestra el comportmeinto de los activos e inactivos. Se centrará el análisis en los años 2023 y 2024 por indicación del profesor.

```{r activos_inactivos}
# Se crea una lista para guardar los trabajadores activos
lista.trab <- list()

# Se llena la lista con un ciclo
for (i in 1:(364 - 328 - 12)) {
  # Se suman los últimos 12 meses, desde el 1 de enero del 2023, para ver los trabajadores activos por mes
  lista.trab[[i]] <-
    rowSums(cotizantes[, (328 + i):(339 + i)] > 10000)
}

# Se convierte la lista a una matriz
lista.trab <- do.call(cbind, lista.trab)

# Si los trabajadores tienen una cotización en los últimos 12 meses, son trabajadores activos
lista.trab <- colSums(lista.trab > 0)

# Se crea un DataFrame con los trabajadores activos e inactivos por año
trabajadores <-
  data.frame(
    meses = ceiling_date(seq(
      from = ymd("2023-01-01"),
      to = ymd("2024-12-01"),
      by = "1 month"
    ), "month") - days(1),
    activos = lista.trab,
    inactivos = 5196 - lista.trab
  )

# Se elimina la variable innecesaria
rm(lista.trab)

# Gráfico de trabajadores activos e inactivos
ggplot(trabajadores, aes(x = meses)) +
  geom_line(aes(y = activos, color = "Activo"), linewidth = 0.75) +
  geom_line(aes(y = inactivos, color = "Inactivo"), linewidth = 0.75) +
  labs(x = "Tiempo", y = "Cantidad de trabajadores") +
  scale_colour_manual(name = "Estado",
                      values = c("Activo" = "steelblue1", "Inactivo" = "tan2")) +
  theme_minimal()
```

