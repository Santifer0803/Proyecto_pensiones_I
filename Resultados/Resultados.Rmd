---
title: "Resultados"
author: "Alejandro Brenes, Santiago Fernández, Eyeri Méndez y Erick Venegas"
date: "`r Sys.Date()`"
output: html_document
---

# Preparación inicial

## Librerías

Inicialmente, cargamos las librerías necesarias para el desarrollo del modelo.

```{r librerias, message = FALSE, warning = FALSE}
pacman::p_load(data.table,
               janitor,
               readxl,
               tidyverse)
```

## Datos del régimen

Se leen las bases de cotizantes y pensionados.

```{r carga_cotpen, message = FALSE, warning = FALSE}
cotizantes <- read_excel("data/BD_Cotizantes.xlsx")
pensionados <- read_excel("data/BD_Pensionados.xlsx")
```

Se realizan algunas correcciones de formato en los pensionados y en los cotizantes.

```{r correcciones_cotpen}
# Se cambian los nombres de las columnas no numéricas de los cotizantes
cotizantes <- cotizantes %>% clean_names()

# Se corrigen los nombres de las columnas de la base de cotizantes
colnames(cotizantes)[4:363] <- format(seq(
  from = ymd("1995-01-01"),
  to = ymd("2024-12-01"),
  by = "1 month"
), "%m-%Y")

# Se corrigen los nombres de la base de pensionados
pensionados <- pensionados %>% clean_names() %>% select(-c("x9"))
```

## Probabilidades de muerte

Se cargan los datos de mortalidad dinámmicos de la SUPEN.

```{r carga_mort}
mortalidad <- read_excel("data/mortalidad.xls")
```

Las probabilidades aparecen como caracteres, por lo que se realiza el cambio correspondiente.

```{r correcciones_mort}
# Se cambia el formato necesario
mortalidad$qx <- as.numeric(mortalidad$qx)

# Se guarda como DataTable
mortalidad <- setDT(mortalidad)
```

## Probabilidades de invalidez

Se procede a cargar las probabilidades de invalidez.

```{r carga_inv}
invalidez <- read_excel("data/invalidez.xlsx")
```

Todas las columnas salen como caracteres, por lo que se cambian.

```{r correcciones_inv}
# Se ponen las edades como números enteros
invalidez$Edad <- as.integer(invalidez$Edad)

# Se corrigen las probabilidades
invalidez$Hombres <- as.numeric(invalidez$Hombres)
invalidez$Mujeres <- as.numeric(invalidez$Mujeres)

# Se corrigen los nombres a un formato más simple
invalidez <- invalidez %>% clean_names()

# Se guarda como DataTable
invalidez <- setDT(invalidez)
```

# Modelo básico

## Parte determinista

En esta sección se concentran las variables invariantes. Es decir, aquellas que no cambiarán durante las iteraciones del modelo.

```{r deterministica_base}
### Beneficios de los cotizantes sin contar estado ###

# Se inicia creando la matriz de edades de los cotizantes, iniciando en la edad del 2025
edades <-
  matrix((2025 - year(cotizantes$fec_nac)),
         nrow = nrow(cotizantes),
         ncol = 95,
         byrow = FALSE
  )

# Se pone el año en cada columna
colnames(edades) <- format(seq(
  from = ymd("2025-01-01"),
  to = ymd("2119-01-01"),
  by = "1 year"
), "%Y")

# Se cambia la edad en cada columna
for (i in 2:ncol(edades)) {
  edades[, i] <- edades[, (i - 1)] + 1
}

# Se corrije la edad máxima a 115
edades <- ifelse(edades > 115, 115, edades)

# Se separan las edades por sexo
edades.h <- edades[which(cotizantes$sexo == 1),]
edades.m <- edades[which(cotizantes$sexo == 2),]

# Se eliminan las edades conjuntas
rm(edades)

### Distintos estados a considerar ###

# Probabilidades de invalidez por sexo
inv.h <-
  matrix(
    invalidez[match(edades.h, edad), hombres],
    ncol = ncol(edades.h),
    nrow = nrow(edades.h),
    byrow = FALSE
  )
inv.m <-
  matrix(
    invalidez[match(edades.m, edad), mujeres],
    ncol = ncol(edades.m),
    nrow = nrow(edades.m),
    byrow = FALSE
  )

# Para las probabilidades de muerte, se inicia creando las matrices vacías
mort.h <- matrix(0, nrow = nrow(edades.h), ncol = ncol(edades.h))
mort.m <- matrix(0, nrow = nrow(edades.m), ncol = ncol(edades.m))

# Se corrigen los nombres de sus columnas
colnames(mort.h) <- colnames(edades.h)
colnames(mort.m) <- colnames(edades.m)

# Se agregan las probabilidades por cada año (columna), para ambos sexos
for(i in 1:ncol(mort.h)) {
  mort.h[, i] <-
    mortalidad[sex == 1 &
                 year == as.double(colnames(mort.h)[i])][.(edad = edades.h[, i]), on = .(edad), qx]
  mort.m[, i] <-
    mortalidad[sex == 2 &
                 year == as.double(colnames(mort.m)[i])][.(edad = edades.m[, i]), on = .(edad), qx]
}
```


## Parte estocástica

En esta sección se encuentra todo objeto que sea, o dependa, de algún elemento estocástico. Son los factores que varían en cada una de las iteraciones del modelo en alguna forma.

